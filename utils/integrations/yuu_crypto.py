#ReadMe: Please replace all fields with <value> with the corresponding value before running this script.

from jwcrypto import jwk, jwe, jws
import json
from config import YUU_PUBLIC_KEY, YUU_PINNACLE_PRIVATE_KEY, YUU_PINNACLE_PRIVATE_KEYPHRASE

# def main():
#     encrypted_token = "eyJ0eXAiOiJKV1QiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWxnIjoiUlNBLU9BRVAtMjU2In0.HKqp1Uad5tlFpp9YUC-1KeiM44Qj9cYLhbcOk8pR5MeXrPZfXd_nEoIHh4Fm3S7tlWrv-n7bVKChTd7sWou3bpA8dscOf-ICqMcGKHu07aF6SAA8TUFKp9oqBK4xIsH0xtrXmvj2wJRD5dQgNmGTvtnjFac6mHMnasxqKrh-gnjFfQIWjGdafrftRJSwz0BHkqlx0vl7KegzmB1JIt9dou9taSkcpW18ECiG5OhaA2xsMuZ_gDKg0ZrpZB-tbot2RcCx6a9M9Sev4dpNGcsvJEjyvCNfnC78PCWELbeV4V76WPlX8gN_t7w9ayqWcP6F5DWaKV13KXemsdw-PlHBFtCbVuHtjflxM7MWZL3jbyL2Gp3ZoqoZ1FMRJwhq3uLCH7_3eIumpThgY7aPEKhNnH1YGmAqHDilPxFe0t9nyaJcahxsbZOpbkFCQJ8L4xQ5iBO8YPIUjNS1Pl89eIgnIKYbB3zIZYniDhj_-6wVNjaOOgUeUeFeRAsboD2pTQPCC6me6q4uVetHPscl7UB4e77xNXLJyXC4BKZNpOGn1WTz1w4B-ozTgDVClFTCbvgaTdHT3DxZ_Vo47i632JtlOTlLMEA48erKwja4cELRGWpt7sYLlSYpkqbx45HRE6WGJ1beB9BBrlNACtKIO8GyMlrnsg6dEEZb2jaMiMMBF0w.I7-v-BZ3jpIXV4Uiz3meNQ.24rNGKxIGJ28E9RwxETrspifeQArygTLysE9pTaOiNGqHU7yIBmW0I_HIEa89l6djXtL1s4EwGHSd9EWnZEY_u4kD5zh3atwac-DqEY0gZZ6kYoFQ4f_G7Mf22jm8XqK0IKLbbulRX5cL_-D8CXR1SM2lNyjzXi3AAOR69LezP3yt7kkRXgjQn1I__9fJgpb8sxjmbsMbPNPVExcDECvWQMHpnDR6IvEX2fjqcoPG_eWKlKYKly_so05OH72aHmfwDS-VHqMisVcgb0RdrzHjsUZh2gpr0aZo_EfOiu0EB3hJ37ZQl9ikP-CRWlDDgQObSx8dPRzn8IPO-j8f53CsV_QRErwQ3ct6ggwszqMKcKEns8ncIYtevAWlGpmksQxK3FFZeRWU9T8iWzFUDbhuWZJ6Q78nXs7KzaW7YhQNiiIjZHlKtonGktwHWyKpjgWr_Dnp71-g_jqi0KRTesk0JOUmq6gXCqhZugH8lrvlNLQmz1eJTQ1mR_PUlH2LO_x73iTvbu5nzNJB3NaDhkz_6HdpR--WPaI5N1Ean6u_6qntJ39Ha3fxgeUWj5vjXc0LnpwmxCo-ZUM3MJ-ULAEYmvDK_QU9NUMZz-Ok0YZwR04cguMrNHz03x95oDsj6AYd2VxkUclzDmhD4SkA_zDA0LD974lWwnLLXxp0U_R5zfu1EyrzzDggI510xcM6PLY7oRanP06JTOwCu5GpLekh7d4tMJZcLHbKLuulvkDm4F8LTYfQJfGqm5wIb6A3s_00v_9medZyS60tgVCiJ6OhdsOh11yrVFAaT8-HeF98cqzOGO3PEtQPC25TH4PPLOH3l96VhuGLhhbn3J-yrZ1wqiAfYamZrHPLPxvWZYLGpxiWZHz6Xq6AmL91PjrM06wubdrbGzxd19DTdt7lLDELs66Q4ZTYUxAi0jzOqH_MjimYM1BkGVoaCExJvTlvvIy9H-oqfjH2a5hukx_2xU089afE4h4CQF2Im6sstDf_EKGu2hfyGpDOXAIu98_s2EgLrGa92uHo3vguZRlGDVRyXpKo4Y4WcbMzQymvmF2oHZmZSb5BjqG4JrUHMfkTJJb5HfVNDP5_NTjAZ7l1sIUEPkgVdDz4_JiKjybA-DDp-XtsnmVa413tdDPE78cCN7f-JYEtI4w5zT9PIFinSJwr-8VFpVtURcmepxdR1Ixgxe52AOU2bObVgped2QlFSDkN2jk_rFylSQywbn1bl_1stqt3XIi0YX4jmg3j6AjT_Ycq_Iz1fcOsbdg-yjaOShR.8axyx9YbWTsIkBdQPKlg7w', 'token_type': 'Bearer', 'expires_in': 1748419041276, 'id_token': 'eyJ0eXAiOiJKV1QiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWxnIjoiUlNBLU9BRVAtMjU2In0.PpAfpwQeOpElT6U0bnCC8_4474IkqTDDMJZXneN2kOB4PyU9JjKPSwXZK0zJ6P5zi6iSp8ghNhYXxxecS7_17Aiym_SYqxDjJSP44XL0PFGuKbIFPrtslIL7cWUeriofvrzevrLDZA8_cHA_xtWquWD3bvTGDxBvvQLU14Bzo8idLWmpPtAQHeoQLLlV8WMTjob3qEmqQG1TsSXV1qz1Cqa2F6Wynkik4Mc-OXkkFxBGM8nQdYsI8HJFLslNvAh6zFh8hCRfY6dApZIhUWBt_2tAjS55-vTYb8AGCM7OY3HOBgGnnl9h7uCt3odnregwzfhpmFLb2GuK9trE3G0lxrEWpCHixOmzCJRlxyDzFd4rXr0viv2gDmXpZ7px9jk_BwLF3qBObdDrnJ0vu4emGv0N65Ezuj8YDFmvpJSDhy2FN5QYaw9ab1pMXzLucYzYuUJIXSyxjI8E3VMx3nB5_VKa9r0gm-pWUZ09mySOusaLUCAc3spXDSuoCQ6A1S7-PHOS7m7zjNJGeAL3XTdVfIcjizyZiF-7BrlS554pu4TZZdEOcxvmU8pv8mtymC_IXqvwdBOfKysDWfT68M0nAGyBSu1cBzN6ZyY09ncNliBSfaCtjHavEoodfV2BuOkiMC6vVyntqMoPXQjOkNUQG4zhw54GZl9Z3mZIPgYZPAc.yMGYCTkjweHmu66Fd02_ng.LnerpZJuxw6eNJzS6vpE95RDS9p_Ult8SY9CZ4s0B3aOJEA1lFtu7I2Adkb73yeiNwHt4MZiGDjPP_-QqNy7JxYu4i8HDoGXZUNIV4HFYHO4lzv5Pmg-75kQXLPxG6WMbpfCWC7YXtJrt4WURzigIrefchaddDcE6DBNmOvIE8UkJuPA7wj-Mkh_6BBeIgFZmIl18Kj0zVi8LLzl_XEvgqS73qgKGpvIH5igWGKAuGU_hc02JoB9llhTQaB5_o1RW0SoaKBIkjMF00ronNHZ0rW-itOil_8heOs1uyPyr4bOGb_HhDz9u_zh39zc50sjq8V3eg3gOZoLbzl4KZ-uJAJSdYwC5_n8_CLgTdnxzXKW0iAUE0kUEN6foONCHOzprmRbpfedEYBl6suQIrqqHXIH-py-tfml42EP6ntFbQ8NM8uorF0ioVPTRWL9NMX4ZoBeR6hFIhvl_W51u9TUeqaj1JVgtKYlqv6L0xzmQnlCWNBKJ7OhnQSSs7aJjmlpbrVcHL4Bm3zNxDbA8hugxUasZxrTyLqxCYiyfnJS6uYQfigysLzX0TP8Nl7z5uN3PbqBG_FzJgbqDdjRY7HvVAcyk8xgAkuOJ-w1cVXZ2avsTmVoJuZCqjZvfLlaFUMsED4ROIpyyznuvbxEUCMupeMx7aO0bZi8vyI1IVdBT0LBisLc9XgOPHR-js-8GsUzIDaz_lSZ8aJEDqAhtEXS5S026LIrTbDZM8K2gKyJsRVxHb-ruxi49T4q8F3o9BEaTVNLvpHi7MwkGQkaq9kz7IzieIu5RMAMZzOHAXwi5IYav-sKuhR8MBxWs6DurtA0YmtNTbe0shxGwycfBhBbL9W9dpEYtMoP_A6a5Foe3-cMK4OaLLaHY0wyQBp7AJRP1LGEbKiIz0fZQga6Pc_T7T7ODks9YlHjXNXT_iLb87ReRkK-2xKC733GdlrvFl5AysBtFwxRsKMIH1ZaEP4VDLaUqExy1UdlhVDp_UY3Uqt_Jos1BsVCzRDLUdR98nk8VcqmVfettIBCeOM3gPT3HC7Kek_Kj4f_uHDcKFcntIfKB4fXdUTVEgDktR7H6ZUWxkg_hNC83qGqC5I9TN7jvDSx-3-cJ9hAAgAALBu044yW_qZrkz95z-hI3l5ibqCKGO_gUetQNIJUq28hxA2ZnJXhi5ZR_fKxZSdqoog5OxpenhtXv0ZEphQZN9cx5sdHWEmqhowwWnhHvj4THwVC4Bj9miqDU8sclNBvs-ESyKWv7bADYHUiYtXPd0KYNEBlnCHukBL01H9QwYkrPjEfSYs4Ebrg3Bahj-2NJ9xkcEzJ5hKG6J4eI7ObSPAVcsC_ZUpmL_HTwxAiSKoD0AqTBnu2bVW4C-zY7NFHzTSXRm7rDjxoiLO5hyYs89hrMKBSfS-_9_NI33WQl2NUZrFoVA.F2qwXieJZ5XRYwUowQ_epQ"
#     yuu_public_key, pinnacle_private_key = load_keys()
#     decrypted_token = decrypt_id_token(encrypted_token, yuu_public_key, pinnacle_private_key)
#     print(decrypted_token)

# Load Party A's public key
def load_keys():
    password = YUU_PINNACLE_PRIVATE_KEYPHRASE.encode('utf-8')
    pinnacle_private_key_pem = YUU_PINNACLE_PRIVATE_KEY.replace('\\n', '\n').encode('utf-8')
    yuu_public_key_pem = YUU_PUBLIC_KEY.replace('\\n', '\n').encode('utf-8')

    # Convert PEM to JWK
    yuu_public_key = jwk.JWK.from_pem(yuu_public_key_pem)
    pinnacle_private_key = jwk.JWK.from_pem(pinnacle_private_key_pem, password=password)

    return yuu_public_key, pinnacle_private_key

def decrypt_id_token(encrypted_token, yuu_public_key, pinnacle_private_key):
    # Decrypt the JWE token using Party B's private key
    jwetoken = jwe.JWE()
    jwetoken.deserialize(encrypted_token)
    jwetoken.decrypt(pinnacle_private_key)

    # Extract the plaintext (which is a signed JWS)
    signed_jws = jwetoken.payload.decode('utf-8')

    # Verify the JWS using Party A's public key
    jwstoken = jws.JWS()
    jwstoken.deserialize(signed_jws)
    jwstoken.verify(yuu_public_key)

    if not jwstoken.payload:
        raise Exception("Invalid Yuu JWT token")

    # Extract the content
    return json.loads(jwstoken.payload.decode('utf-8'))
